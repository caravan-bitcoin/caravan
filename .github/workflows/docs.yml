name: Publish Docs to Branch

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  publish-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies from monorepo root
        run: npm ci

      - name: Build all workspace packages
        run: npm run build

      - name: Generate docs
        run: npm run docs

      - name: Switch to docs branch and publish
        run: |
          # Configure git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # Save the generated docs to a temp location
          mv docs docs_temp

          # Create and switch to an orphan docs branch
          git checkout --orphan docs

          # Clear existing contents but preserve git directory
          git rm -rf . || true

          # Copy the new docs in
          cp -r docs_temp/* .

          # Stage and commit
          git add .
          git commit --no-verify -m "chore(docs): update typedocs [skip ci]" # To prevent precommit hook check

          # Force push to create/update the docs branch
          git push -f origin docs
